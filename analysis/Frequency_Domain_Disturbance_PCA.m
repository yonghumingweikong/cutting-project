clc; close all;

data_tf_d_d_d = [
    5.57853426	3.44298056	6.257088894	5.96503353	4.454873188	5.652651746	6.74423781	2.567983729;
9.917729225	0.7593209926	4.992219502	5.418817757	5.315907841	6.071663535	4.437198127	-6.330228822;
6.114092876	1.891609024	4.702159088	2.869152862	3.301744371	4.173310144	4.801639953	0.9206158834;
-4.506398813	-2.927127473	5.926362	3.421664716	3.30753488	5.530464505	-1.537035645	-9.879374935;
0.2270334296	8.910985303	6.705432897	7.171322405	3.898740529	6.522953235	1.744783564	0.8263788232;
3.050804173	2.888161157	-0.571518655	5.094186653	0.3919708494	2.625388999	5.287905823	2.711173121;
3.937424139	2.741657578	5.466695864	5.798651351	4.151960701	6.464529781	6.256126236	-9.930361408;
5.451611131	2.638171147	4.582209147	6.406146015	3.330091796	8.080919593	5.715016123	4.10892101;
-2.831323093	-2.945247863	4.646031418	7.586232598	4.524492279	0.9655913654	-6.832131578	4.503443515;
7.629002344	3.642766838	2.64143581	4.61345903	2.468620202	5.541714294	6.195692407	1.048762808;
-0.9400038143	2.364831796	3.35752753	5.015293599	3.083792798	6.372212838	5.878684271	9.509147248;
-5.959006318	-2.244907409	-0.8506632907	5.469039955	0.6295503113	5.67551925	-4.837162522	1.721576545;
-2.354220039	-3.137148246	2.547974491	6.282849446	0.160973221	7.290027451	-7.444773072	-7.152971763;
5.871710546	1.228372641	3.048782143	8.422453664	1.614384863	2.696347676	2.788246196	4.943748379;
9.759041388	3.505429845	6.126998567	8.623114236	0.1092344297	5.876529997	5.497933694	3.594353104;
7.646683812	2.608591919	2.261895899	4.465068751	0.4444611184	6.705548247	6.67213653	2.157765128;
-8.300502977	-1.22957203	-0.9937575221	-5.275618402	-1.190285661	-4.493331424	4.551617858	-4.086503616;
6.654482027	4.216683917	4.485711812	7.201957438	0.9364201516	8.654117556	2.921684752	0.6626090305;
5.70810901	0.8429297936	-2.238065097	-5.157577576	-2.807693835	-6.294670025	-4.716694799	-9.967707197;
3.010290052	2.660383668	3.838169176	9.483125563	0.445585615	5.646212728	4.98049589	5.2516916;
-8.05280877	-4.648567289	7.937388667	1.573611767	3.038061042	5.701206328	-1.717255016	-9.712013763;
4.533620064	1.565945467	5.232654338	3.854032347	5.43901046	3.865432766	5.27628755	-5.705816648;
-9.537044551	-3.123365315	-1.83160916	-5.627018713	-0.7799962979	-7.571080341	7.277937139	-1.663754452;
-0.3444731271	2.759227533	2.65332476	4.811159408	2.140697481	5.548794126	6.065993883	-9.833112454;
7.712367313	1.878998368	3.236330082	3.013268949	3.355478349	6.209015499	6.700372656	2.694907177;
4.557034994	0.4455584113	1.693160702	7.00539596	1.1386798	6.144391688	1.199285306	-3.359890969;
1.601291956	1.507402752	-0.9772199326	-5.937314595	-3.457914266	-6.989713708	-2.832570515	-1.338643646;
1.463992909	1.010086473	0.3258038248	2.716924379	-0.6367675472	5.081581213	5.773393445	3.354641041;
-0.3776166847	-4.009229291	0.924664298	-5.735377983	-0.388682514	-6.747621761	4.107930426	-1.510082995;
9.658694355	1.62689101	6.00882159	4.699444402	4.188425652	4.218193605	3.693930793	4.848280934;
-5.296586626	-2.125709365	-3.300079633	-4.989249627	-2.947906508	-6.336436423	4.388770462	-9.775183177;
2.44964156	7.593990898	4.299062345	4.610348196	0.3309615258	5.815237543	2.108165763	0.5476455236;
-7.297764521	-1.70312948	2.687552842	-3.275572171	-7.455456918	-5.430990225	7.380031344	-0.8017697859;
0.08571617305	-1.251346185	5.659686929	2.702932873	2.918820854	5.447391108	-5.331246056	2.653812292;
-3.506446909	-3.947845045	0.3607825658	5.552978075	1.678839635	7.308863051	-6.39430792	3.39852849;
-3.496576757	-1.897139231	-2.63060308	-3.2945194	-3.833761639	-4.103122493	5.134102765	-1.36815033;
1.356241998	7.232676382	4.325927775	7.742621456	0.0678866678	9.841988075	2.791099392	0.61825645;
3.170080879	-2.036349317	7.415672112	5.709688684	-1.718020782	6.815562849	-4.160552485	3.94040674;
2.044954659	-2.762875485	0.6274916712	2.883025531	-3.652352061	3.520279473	-5.063218007	1.618608584;
3.643620319	1.593856258	4.956533439	4.819604961	3.322429816	6.383845893	3.978022684	-9.617546789;
-0.8837866413	-2.367390198	-2.161328856	-4.892777618	-2.274035853	-7.303473491	7.177866006	-3.309217563;
-5.534603214	-2.050284503	-3.686164441	-3.641781248	0.1094286521	-7.544395148	6.394581192	-2.194948659;
-0.9723352179	-3.185078788	-3.473997769	1.428925678	-0.3478659762	0.8087206756	-5.163438558	1.642051928;
3.399966495	1.85246392	4.039725336	1.380099031	1.643945709	5.120896207	2.27480556	1.670274466;
5.192857608	3.024520109	3.600522867	4.627653591	3.328744149	6.006053671	5.987061416	1.733369486;
-0.8664805862	-2.342013893	7.071170456	6.192428088	4.738697056	7.47008114	-4.287017202	1.945869745;
0.9798080707	1.560902669	0.413767541	-2.923494497	3.942595897	-5.471019264	-4.868915774	-1.564993075;
3.48180397	1.776769864	-1.139591256	-6.402343293	2.610677329	-8.525149444	-6.377724143	4.677929965;
2.501782775	3.454475628	5.085671027	-5.143692156	-3.296513641	-3.219052354	-5.845681626	-0.2997288011;
7.901198058	0.6253833482	3.216976018	1.882236845	2.641411071	6.152318396	2.271542906	4.734126615;
3.634954915	2.367064764	3.196856061	4.133314964	2.628288507	6.753110687	5.438350391	1.212032835;
3.692758863	1.577509437	-1.407469107	4.256930518	-4.474906714	6.940845992	3.710229666	1.153235663;
-1.532990002	-2.826121623	6.184475569	5.395548664	3.686592769	4.04501645	-7.455054712	9.780147458;
2.115965494	0.770385401	-3.919717431	-2.835384874	-3.306912108	-4.228754844	-2.926856094	-9.901695114;
6.787474099	2.333565478	-4.692916639	-4.613740229	-3.438070607	-4.341008045	-5.295611482	-4.612892651;
4.567726725	3.377174082	4.40531533	6.928054063	1.557211704	7.649473704	5.234958064	-2.850413224;
-2.86784642	-5.62168276	4.589139947	5.307343806	3.009813545	6.579047765	-2.621223076	2.533949756;
-6.019832202	-1.363984707	4.702592584	4.11900636	2.254181865	6.106345192	-5.386255002	-9.842211461;
1.995620087	-1.991249631	3.970176156	6.705220253	1.929225233	6.812517991	-2.558275805	-4.915944267;
-1.403129656	-3.674410351	5.977722994	4.926684599	3.236307214	4.985489048	-8.571718791	9.847308786;
-4.880550817	-2.529176427	4.873954701	5.197421428	2.127324078	5.431158362	-5.800443632	5.501518488;
-9.092607488	-0.008222774874	-5.023138384	-9.245536074	-4.79039951	-5.73936113	1.366077884	-2.010276238;
7.311991998	3.190076984	5.377858973	5.136059768	3.067996517	8.000435852	3.633767463	3.842626967;
4.494120739	2.634356821	6.048919134	4.152279494	3.73682655	5.817191252	7.024327809	4.610491894
];

profiles = zeros(height(profiles_1)+height(profiles_2)+height(profiles_5),length(profiles_1));
profiles(1:height(profiles_1),:) = profiles_1;
profiles(height(profiles_1)+1:52,:) = profiles_2;
profiles(53:end,:) = profiles_5;

% for n = 1:height(profiles)
%     M = find(profiles(n,:),1,'last');
%     actual = profiles(n,1:M);
%     
%     a1 = data_tf_d(indx,1);
%     a2 = data_tf_d(indx,2);
%     b1 = data_tf_d(indx,3);
%     b2 = data_tf_d(indx,4);
%     g1 = data_tf_d(indx,5);
%     g2 = data_tf_d(indx,6);
%     Ki = data_tf_d(indx,7);
%     l3 = data_tf_d(indx,8);
%     y = ADRC_TF_rollout(a1,a2,b1,b2,g1,g2,Ki,l3,reference(1:M),Ts);
%     
%     clf;
%     plot(y); hold on;
%     plot(actual); grid on;
%     legend('model','actual');
%     saveas(gcf,'./img/'+string(n)+'.png')
% end

clust1 = find((score(:,1)>-1) & (score(:,2)>0));
clust2 = find(score(:,1)<-5);
clust3 = find((score(:,1)>-5) & (score(:,2)<-2));

for n = 1:length(clust1)
    
    indx = clust1(n);
    
    M = find(profiles(indx,:),1,'last');
    actual = profiles(indx,1:M);
    
    a1 = data_tf_d(indx,1);
    a2 = data_tf_d(indx,2);
    b1 = data_tf_d(indx,3);
    b2 = data_tf_d(indx,4);
    g1 = data_tf_d(indx,5);
    g2 = data_tf_d(indx,6);
    Ki = data_tf_d(indx,7);
    l3 = data_tf_d(indx,8);
    y = ADRC_TF_rollout(a1,a2,b1,b2,g1,g2,Ki,l3,reference(1:M),Ts);
    
    clf;
    plot(y); hold on;
    plot(actual); grid on;
    legend('model','actual');
    saveas(gcf,'./img/ADRC_TF_d_fit/Cluster_1/'+string(indx)+'.png')
end

for n = 1:length(clust2)
    
    indx = clust2(n);
    
    M = find(profiles(indx,:),1,'last');
    actual = profiles(indx,1:M);
    
    a1 = data_tf_d(indx,1);
    a2 = data_tf_d(indx,2);
    b1 = data_tf_d(indx,3);
    b2 = data_tf_d(indx,4);
    g1 = data_tf_d(indx,5);
    g2 = data_tf_d(indx,6);
    Ki = data_tf_d(indx,7);
    l3 = data_tf_d(indx,8);
    y = ADRC_TF_rollout(a1,a2,b1,b2,g1,g2,Ki,l3,reference(1:M),Ts);
    
    clf;
    plot(y); hold on;
    plot(actual); grid on;
    legend('model','actual');
    saveas(gcf,'./img/ADRC_TF_d_fit/Cluster_2/'+string(indx)+'.png')
end

for n = 1:length(clust3)
    
    indx = clust3(n);
    
    M = find(profiles(indx,:),1,'last');
    actual = profiles(indx,1:M);
    
    a1 = data_tf_d(indx,1);
    a2 = data_tf_d(indx,2);
    b1 = data_tf_d(indx,3);
    b2 = data_tf_d(indx,4);
    g1 = data_tf_d(indx,5);
    g2 = data_tf_d(indx,6);
    Ki = data_tf_d(indx,7);
    l3 = data_tf_d(indx,8);
    y = ADRC_TF_rollout(a1,a2,b1,b2,g1,g2,Ki,l3,reference(1:M),Ts);
    
    clf;
    plot(y); hold on;
    plot(actual); grid on;
    legend('model','actual');
    saveas(gcf,'./img/ADRC_TF_d_fit/Cluster_3/'+string(indx)+'.png')
end