data_tf = [2.404293575,4.354778947,-4.932784876,-8.049114299,-5.031250457,-5.646681583,-3.797475422,-0.8649906534;
3.415799363,5.640294684,2.886879424,7.269958775,3.437662352,5.919927711,5.794615665,1.012339757;
-6.269475145,4.046463629,5.149436021,3.064792799,3.820503442,1.87214593,5.667492053,0.8714510079;
-5.590936215,-4.189361996,6.061075842,3.61165808,3.603593179,6.7139063,-1.343630574,1.299301143;
-0.3424867135,-9.035154295,7.130680452,7.057384797,3.557357051,6.090692978,-1.904432572,-8.90254326;
% -2.570080298,-3.850447592,-1.88320437,7.757392924,-1.261775827,4.519025625,-2.75489994,1.554376475;
3.474625446,2.519378808,2.484818365,3.608879,1.89192515,4.320008134,3.796468551,1.606487806;
-2.35787117,2.985333753,4.077091586,2.49020917,3.633059404,1.978995904,3.231113676,1.491670025;
-2.82951873,-3.414690911,-3.37730713,-6.143131839,-5.403866164,-0.3934062178,1.375590114,-0.3695724621;
8.144783156,-4.645919908,-4.76649767,-5.013980225,-4.359778148,-3.247857435,5.480969934,-1.193935038;
4.64237458,3.595429166,5.908264831,3.877810896,5.504836418,6.989259289,4.017551312,2.52770319;
-2.648548194,-2.688183558,1.292866138,-6.865798354,1.418001596,-7.485319907,5.586723351,9.282226067;
-3.61333726,3.08608378,5.914509277,4.901685167,3.066536207,5.191148747,8.26105189,4.375143415;
% -2.648652832,-5.712774866,-1.706386105,-6.730136907,-1.691388994,-2.050542523,3.256885739,-3.108041134;
% 6.33879814,1.19E-05,5.924273446,3.947463486,0.3567425027,5.02703604,1.993027698,6.371604122;
-3.588533492,-3.027950527,6.031140401,5.190958523,2.244413354,7.716747059,-5.78901299,-9.827575644;
% 1.81901417,5.374289706,-4.621554887,-5.888423548,-0.9256137188,-5.606603492,-3.301886064,-1.508632271;
% -6.265905162,-1.315152553,2.513831981,5.731010614,-0.2647943075,7.395091046,-2.508176921,1.158538857;
-5.059862227,-4.358394046,2.096932019,4.776507468,1.63768325,6.428880841,-5.184401523,2.538637578;
% 5.33415677,3.204009008,6.27226188,9.103728216,1.826524349,5.469879445,3.168778979,2.300691155;
3.132659172,4.469412062,6.852340497,5.502429959,3.543244727,4.104821265,1.603691837,1.530130142;
3.09775242,4.259140739,1.935126743,4.5096198,1.748773456,5.668030551,3.416907144,-9.983725195;
-4.134295046,-3.812521836,-2.324087618,-6.064343806,-0.6525021564,-7.700360034,7.070277936,-2.087647657;
6.323912725,4.608150134,7.399818571,5.487797188,6.260452224,7.587602472,4.946709566,3.853501037;
-1.43848688,-1.612418156,0.6547174036,4.847234523,-0.8834462433,7.966486605,-4.107284434,-9.986379326;
% 1.8100315,5.717632507,6.416306088,6.071109865,3.901335969,2.884978704,6.685759815,8.041832771;
4.684962368,2.562875468,0.447257714,5.417561403,2.110513802,7.083344352,5.041037009,1.572066426;
% 3.946903267,2.279890156,-1.227589334,3.94810033,-0.605279268,6.75223412,7.14369341,1.5209023;
4.599922878,3.776063589,0.8322270216,3.879684183,0.3525778004,6.834719964,4.041845624,1.917739147;
4.055058035,1.470660445,4.652322592,4.103458881,3.347239448,3.268680733,2.240318738,3.914432665;
-3.147494924,-6.105152116,-3.201750185,-4.363645282,-2.21334728,-5.93316357,5.084946317,-1.61567286;
% 7.040743665,3.516349079,2.007892388,5.85741061,-0.9195748511,7.351991113,2.224777145,1.346989585;
% 6.319426417,1.533306522,-7.206220076,3.624288583,2.450232255,5.546887921,5.535905663,0.7060334486;
-0.6733219999,1.910666768,4.773828018,1.838879652,2.958005899,3.717404683,4.013549478,1.261587647;
-4.341203761,-3.066880144,-2.462434923,-3.491605336,-2.442807202,-5.745335968,4.909819122,-2.914759379;
% 6.159196078,1.768037984,-0.616705514,-4.970491089,0.4318212254,-8.173794066,-5.6023028,7.267058613;
% 3.754202865,7.156974558,3.567298422,6.613951121,-0.1588445916,9.993316925,2.39938452,0.5718228077;
% 1.653147279,3.034462204,-1.997059093,-3.917893007,4.192017354,-5.119940182,-5.757677308,-1.743057118;
% 3.930827343,3.798851685,-0.5762648821,3.675516416,-3.554043343,5.741120341,5.743439712,1.342222817;
1.99979089,-5.56554495,5.928144429,5.328987218,3.565699007,4.964215748,-3.606369718,-8.936851447;
4.297436752,1.919280386,1.408670522,-4.01544527,-0.1908200527,-6.669165872,-4.250735298,-1.470171367;
1.874002456,2.450859097,4.433078477,3.601897473,1.691123461,6.618276246,4.540423439,1.52484165;
6.363726793,1.382490641,3.520787318,-6.438033228,-6.473958517,-5.198774807,-3.611276823,-3.451310425;
2.199957187,3.101264198,5.532633632,4.320344205,2.326395203,7.939471843,5.980522953,1.935487554;
-2.097434313,3.70678324,5.758016246,4.396469669,5.180673822,4.524785204,5.431987425,1.35882423;
1.430378873,8.807965085,6.470677334,4.11195769,4.517898615,5.933319688,3.253162983,1.278145986;
% 7.459923894,1.901806975,3.909556028,3.094732402,4.292507155,7.340325946,5.18730454,1.018755531;
2.857273128,1.761027785,-1.165042963,3.906035388,0.0724613264,4.127995279,5.865932272,2.848110451;
% -4.079955322,-2.48586896,0.4968181944,2.156759631,2.698740438,2.141512562,-7.568613725,0.5723956648;
-5.309134841,-3.166711302,4.204357079,3.391078066,2.923882237,5.011116418,-6.330335367,-9.954446566];
% -6.388777213,-1.898315493,-4.890772542,-3.896270824,-3.794360722,-7.48471914,5.660341556,-1.46555558;
% 2.152704244,3.492298561,-1.553039558,-5.540015355,1.74348762,-8.006483024,-7.847164784,-1.294177594];

[coeff,score,latent,tsquared,explained] = pca(data_tf);

poi = 21;

close all; clc;
figure;
scatter(score(1:20,1),score(1:20,2),'o'); hold on;
scatter(score(21:end,1),score(21:end,2),'v');
title('PCA')
% scatter(score(poi,1),score(poi,2),150,'filled','d');

% figure;
% scatter3(score(1:20,1),score(1:20,2),score(1:20,3),'o'); hold on;
% scatter3(score(21:end,1),score(21:end,2),score(21:end,3),'v');

clust1 = find((score(:,1)>-1) & (score(:,2)>0));
clust2 = find(score(:,1)<-5);
clust3 = find((score(:,1)>-5) & (score(:,2)<-2));

figure;
scatter(score(1:20,1),score(1:20,2),'o'); hold on;
scatter(score(21:end,1),score(21:end,2),'v');
scatter(score(clust1,1),score(clust1,2),'filled','d'); 
title('PCA (Cluster 1)');

figure;
scatter(score(1:20,1),score(1:20,2),'o'); hold on;
scatter(score(21:end,1),score(21:end,2),'v');
scatter(score(clust2,1),score(clust2,2),'filled','d');
title('PCA (Cluster 2)');

figure;
scatter(score(1:20,1),score(1:20,2),'o'); hold on;
scatter(score(21:end,1),score(21:end,2),'v');
scatter(score(clust3,1),score(clust3,2),'filled','d');
title('PCA (Cluster 3)');

profiles = zeros(height(profiles_1)+height(profiles_2),length(profiles_1));
profiles(1:height(profiles_1),:) = profiles_1;
profiles(height(profiles_1)+1:end,:) = profiles_2;

figure; hold on;
for n = 1:length(clust1)
    
    indx = clust1(n);
    M = find(profiles(indx,:),1,'last');
    
    a1 = data_tf(indx,1);
    a2 = data_tf(indx,2);
    b1 = data_tf(indx,3);
    b2 = data_tf(indx,4);
    g1 = data_tf(indx,5);
    g2 = data_tf(indx,6);
    Ki = data_tf(indx,7);
    l3 = data_tf(indx,8);
    
    [y] = ADRC_TF_rollout(a1,a2,b1,b2,g1,g2,Ki,l3,reference(1:M),Ts);
    plot(y);
    title('Cluster 1 (model)')
    
end

figure; hold on;
for n = 1:length(clust1)
    
    indx = clust1(n);
    M = find(profiles(indx,:),1,'last');
    actual = profiles(indx,1:M);
    plot(actual);
    title('Cluster 1 (actual)')
    
end

figure; hold on;
for n = 1:length(clust2)
    
    indx = clust2(n);
    M = find(profiles(indx,:),1,'last');
    
    a1 = data_tf(indx,1);
    a2 = data_tf(indx,2);
    b1 = data_tf(indx,3);
    b2 = data_tf(indx,4);
    g1 = data_tf(indx,5);
    g2 = data_tf(indx,6);
    Ki = data_tf(indx,7);
    l3 = data_tf(indx,8);
    
    [y] = ADRC_TF_rollout(a1,a2,b1,b2,g1,g2,Ki,l3,reference(1:M),Ts);
    plot(y);
    title('Cluster 2 (model)')
    
end

figure; hold on;
for n = 1:length(clust2)
    
    indx = clust2(n);
    M = find(profiles(indx,:),1,'last');
    actual = profiles(indx,1:M);
    plot(actual);
    title('Cluster 2 (actual)')
    
end

figure; hold on;
for n = 1:length(clust3)
    
    indx = clust3(n);
    M = find(profiles(indx,:),1,'last');
    
    a1 = data_tf(indx,1);
    a2 = data_tf(indx,2);
    b1 = data_tf(indx,3);
    b2 = data_tf(indx,4);
    g1 = data_tf(indx,5);
    g2 = data_tf(indx,6);
    Ki = data_tf(indx,7);
    l3 = data_tf(indx,8);
    
    [y] = ADRC_TF_rollout(a1,a2,b1,b2,g1,g2,Ki,l3,reference(1:M),Ts);
    plot(y);
    title('Cluster 3 (model)')
    
end

figure; hold on;
for n = 1:length(clust3)
    
    indx = clust3(n);
    M = find(profiles(indx,:),1,'last');
    actual = profiles(indx,1:M);
    plot(actual);
    title('Cluster 3 (actual)')
    
end