close all; clc;

N = height(profiles_2);
Param = zeros(N,8);
feval = zeros(1,N);
d = [-0.0452221324855130	-0.0321155841390561	-0.0200272695664998	-0.00963230536469243	-0.00141484223760508	0.00431251019593282	0.00739627036980459	0.00784657754788608	0.00585849504445784	0.00183312232353367	-0.00361735319138980	-0.00969325182874725	-0.0154725478769288	-0.0200019241699083	-0.0224013236086923	-0.0219758211057261	-0.0183158291222971	-0.0113765800796973	-0.00152183377331120	0.0104828892895064	0.0235332868301802	0.0363006475243056	0.0473791277278881	0.0554450191422360	0.0594036757307342	0.0585149064709974	0.0524710981615977	0.0414271529950538	0.0259852013770007	0.00711649369203934	-0.0139541819378308	-0.0358904274656530	-0.0573936244290796	-0.0773214637194478	-0.0947599485085554	-0.109039397505952	-0.119699554530900	-0.126444563928575	-0.129112054614633	-0.127663288715688	-0.122207713339189	-0.113026239321965	-0.100568109136786	-0.0854266881423335	-0.0682847160977737	-0.0498497782653680	-0.0308125234143243	-0.0118245944277555	0.00650157376027417	0.0235704013112450	0.0387924530887312	0.0515970514874715	0.0614657202970080	0.0679869025876212	0.0709120450509437	0.0701874038250125	0.0659480376578148	0.0584814414355080	0.0481676424086704	0.0354158174134896	0.0206159306113834	0.00410910414047326	-0.0138190314454997	-0.0329289443778318	-0.0530117058597364	-0.0738702523603417	-0.0953033169937690	-0.117095124311866	-0.139000873760676	-0.160729730849697	-0.181927354725382	-0.202160165831133	-0.220909165506829	-0.237580177241500	-0.251531897089717	-0.262116737370624	-0.268727703906261	-0.270842536847648	-0.268061605674640	-0.260139149846500	-0.247017423057143	-0.228860899538210	-0.206086291105414	-0.179383649938571	-0.149717739935824	-0.118308009832156	-0.0865772591469129	-0.0560663579318349	-0.0283150866052520	-0.00471889842099074	0.0136011247320376	0.0258911885413975	0.0318082510419414	0.0314059404155051	0.0250883594454014	0.0135487524189758	-0.00230069170990742	-0.0213978162821721	-0.0425971141731509	-0.0647330223444702	-0.0866775706698152	-0.107388156729215	-0.125935080167764	-0.141500607111528	-0.153364603661643	-0.160879362792376	-0.163466226601845	-0.160661044654424	-0.152185809447523	-0.138036566185406	-0.118551078630686	-0.0944268733700962	-0.0666854317879560	-0.0365861442469218	-0.00551059627066479	0.0251703712871236	0.0542118646094953	0.0805714336164924	0.103446013230676	0.122264824837593	0.136663994185290	0.146469479251643	0.151695153935078	0.152553708479835	0.149472208853374	0.143094311103831	0.134260302650101	0.123952834231152	0.113214379213608	0.103053148109775	0.0943419320018906	0.0877411762050001	0.0836583074290024	0.0822397563651302	0.0833991480531522	0.0868792385722291	0.0923298606216711	0.0993793850236263	0.107687333287188	0.116954652515761	0.126892190974558	0.137173466180199	0.147392377353889	0.157042128613438	0.165526289603741	0.172184667187235	0.176328367909242	0.177286685115453	0.174458677848419	0.167382824361465	0.155813827512779	0.139793085491789	0.119696906986495	0.0962449139229562	0.0704648985649195	0.0436110206159720	0.0170473422110280	-0.00787717070631117	-0.0299432927575216	-0.0481589391344729	-0.0618265309634354	-0.0705843958955607	-0.0744320230689274	-0.0737291721511034	-0.0691579178124281	-0.0616524730624631	-0.0522998706205004	-0.0422164101188296	-0.0324277417230738	-0.0237682256534376	-0.0168115978539166	-0.0118421497972078	-0.00886100564808773	-0.00763122717780877	-0.00774804558693172	-0.00872552575363776	-0.0100922006256444	-0.0114723232126580	-0.0126409517024817	-0.0135413205850376	-0.0142596962008728	-0.0149669501419589	-0.0158418625807657	-0.0169971014370621	-0.0184318612758799	-0.0200242484540603].';

for i = 1:N
    
    M = find(profiles_2(i,:),1,'last');
    actual = profiles_2(i,1:M);
    
    L1 = @(x) sum( (abs(ADRC_TF_disturbance_rollout(x(:,1),x(:,2),x(:,3),x(:,4),x(:,5),x(:,6),x(:,7),x(:,8),reference(1:M),Ts,d(1:M)) ...
    - actual)).' ) / M;

    % Setting options
    options = ceoptdef('ConvergenceLimit', 3e-2, 'SmoothingType', 'fixed', 'EliteRatio', 0.1, ...
                       'Display', 'iter', 'PopulationSize', 100, 'Generations', 100);

    % Defining variables limits
    l = -10*ones(1,8); u = 10*ones(1,8);

    % Applying the optimization method
    [X_opt, y_opt] = ceo_disturbance_tf(L1, l, u, options, [], [], reference(1:M), actual, Ts,d(1:M));    
    Param(i,:) = X_opt;
    feval(i) = y_opt;
    
end