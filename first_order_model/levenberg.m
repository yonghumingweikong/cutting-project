clc; close all;

N = height(profiles_1);
Param = zeros(N,4);
feval = zeros(1,N);

problem.options = optimoptions('fsolve','Algorithm','levenberg-marquardt','Display','iter');
problem.solver = 'fsolve';

CEM_param = [28.94337267	54.99121265	7.499709869	6.036431562;
90.48879084	22.73359287	16.67794311	3.214623788;
92.76390883	61.82712589	-16.39101739	4.580556441;
26.75427059	97.33687277	6.034954101	5.763640855;
23.47174523	85.10168926	-1.444062721	8.885473699;
16.30657101	30.9900807	-4.863730017	9.080408374;
76.30907793	18.86384664	2.104956386	3.247175667;
57.05491442	29.05260539	-37.83500801	1.345229539;
4.213260187	11.59397691	27.62400245	6.414680652;
63.92618285	87.57888181	8.66844883	3.684479407;
-24.63027969	54.93214163	-21.12633776	-0.4300624034;
47.29402412	24.85636514	47.30878865	0.8882987592;
81.63106781	-30.97862549	9.070029529	-7.32373231;
6.873047975	57.70954756	-2.016687342	9.744116606;
5.335021136	54.10821461	-16.04987124	5.721960952;
24.54566633	68.03878907	-17.80534829	3.470732909;
25.1534815	64.11647379	-26.19347955	7.320962794;
50.37871032	48.16773593	-12.85472676	8.072570833;
-55.76195752	53.65397549	20.67161075	-4.982161378;
9.359902856	62.52892871	-3.034543918	7.03875338];

for i = 1:N

    M = find(profiles_1(i,:),1,'last');
    actual = profiles_1(i,1:M);

    L1 = @(x) sum( (abs(ADRC_FO_rollout(x(1),x(2),x(3),x(4),reference(1:M),Ts) ...
            - actual)).' ) / M;
    
    problem.objective = L1;
    problem.x0 = CEM_param(i,:);
    x = fsolve(problem);

    Param(i,:) = x;
    
    y_hat = ADRC_FO_rollout(x(:,1),x(:,2),x(:,3),x(:,4),reference(1:M),Ts);
    clf; plot(y_hat); hold on; plot(actual,'--'); grid on; pause(0.2); 
    
end